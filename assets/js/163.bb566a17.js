(window.webpackJsonp=window.webpackJsonp||[]).push([[163],{668:function(s,a,n){"use strict";n.r(a);var e=n(21),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"rdb持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rdb持久化"}},[s._v("#")]),s._v(" RDB持久化")]),s._v(" "),n("ol",[n("li",[s._v("save和bgsave源码")])]),s._v(" "),n("div",{staticClass:"language-c++ line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('void saveCommand(redisClient *c) {\n\n   // BGSAVE 已经在执行中，不能再执行 SAVE\n   // 否则将产生竞争条件\n   if (server.rdb_child_pid != -1) {\n       addReplyError(c,"Background save already in progress");\n       return;\n   }\n\n   // 执行 \n   if (rdbSave(server.rdb_filename) == REDIS_OK) {\n       addReply(c,shared.ok);\n   } else {\n       addReply(c,shared.err);\n   }\n}\n\nvoid bgsaveCommand(redisClient *c) {\n\n   // 不能重复执行 BGSAVE\n   if (server.rdb_child_pid != -1) {\n       addReplyError(c,"Background save already in progress");\n\n   // 不能在 BGREWRITEAOF 正在运行时执行\n   } else if (server.aof_child_pid != -1) {\n       addReplyError(c,"Can\'t BGSAVE while AOF log rewriting is in progress");\n\n   // 执行 BGSAVE\n   } else if (rdbSaveBackground(server.rdb_filename) == REDIS_OK) {\n       addReplyStatus(c,"Background saving started");\n\n   } else {\n       addReply(c,shared.err);\n   }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("自动间隔性保存")])]),s._v(" "),n("blockquote",[n("p",[s._v("服务器间隔性检车saveparams中的任意一个条件是否得到满足，如果得到满足，执行bgsave.saveparams[0]表示距离上次bgsave900s内,至少有一次数据库变化。")])]),s._v(" "),n("p",[s._v("[外链图片转存中...(img-SwAqAX8z-1653145947293)]")]),s._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[s._v("rdb文件结构\n[外链图片转存中...(img-Prs54pGE-1653145947294)]\n其中database结构如下：\n[外链图片转存中...(img-rn1gUv6w-1653145947294)]\n其中ksy_value_pairs结构如下\n[外链图片转存中...(img-B62S2gV5-1653145947295)]")])]),s._v(" "),n("blockquote",[n("p",[s._v("type指定了value的类型。value的编码方式不同期存储结构也不同。")])]),s._v(" "),n("h2",{attrs:{id:"aof持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#aof持久化"}},[s._v("#")]),s._v(" AOF持久化")]),s._v(" "),n("ol",[n("li",[s._v("aof的实现\n命令追加：所有客户端命令都会被存到redis_server的aof_buf缓冲区。\n文件写入：操作系统在写入文件的时候，先写入缓存，缓存满了才写入文件。\n文件同步：flushAppendOnlyFile()负责将aof_buf写入文件aof。")])]),s._v(" "),n("blockquote",[n("p",[s._v("flushAppendOnlyFile中配置的appendfsync决定同步策略。appendfsync有三个取值：always(每次写入都同步)、everysec(每次事件都写入但不同步，每秒同步)、 no(每次事件都写入但不同步，操作系统决定同步)；")])]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[s._v("aof的载入与还原\n[外链图片转存中...(img-pNMyXRLJ-1653145947295)]")]),s._v(" "),n("li",[s._v("AOF重写\n[外链图片转存中...(img-i1nhwgNs-1653145947295)]")])])])}),[],!1,null,null,null);a.default=r.exports}}]);