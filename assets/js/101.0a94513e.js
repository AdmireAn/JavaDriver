(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{603:function(s,t,a){"use strict";a.r(t);var n=a(21),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("处于安全的考虑，不同进程之间的内存空间是相互隔离的，也就是说 "),a("code",[s._v("进程A")]),s._v(" 是不能访问 "),a("code",[s._v("进程B")]),s._v(" 的内存空间，反之亦然。如果不同进程间能够相互访问和修改对方的内存，那么当前进程的内存就有可能被其他进程非法修改，从而导致安全隐患。")]),s._v(" "),a("p",[s._v("不同的进程就像是大海上孤立的岛屿，它们之间不能直接相互通信，如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010001527799.png",alt:""}})]),s._v(" "),a("p",[s._v("但某些场景下，不同进程间需要相互通信，比如："),a("code",[s._v("进程A")]),s._v(" 负责处理用户的请求，而 "),a("code",[s._v("进程B")]),s._v(" 负责保存处理后的数据。那么当 "),a("code",[s._v("进程A")]),s._v(" 处理完请求后，就需要把处理后的数据提交给 "),a("code",[s._v("进程B")]),s._v(" 进行存储。此时，"),a("code",[s._v("进程A")]),s._v(" 就需要与 "),a("code",[s._v("进程B")]),s._v(" 进行通信。如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010000123374.png",alt:""}})]),s._v(" "),a("p",[s._v("由于不同进程间是相互隔离的，所以必须借助内核来作为桥梁来进行相互通信，内核相当于岛屿之间的轮船，如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010000132297.png",alt:""}})]),s._v(" "),a("p",[s._v("内核提供多种进程间通信的方式，如："),a("code",[s._v("共享内存")]),s._v("，"),a("code",[s._v("信号")]),s._v("，"),a("code",[s._v("消息队列")]),s._v(" 和 "),a("code",[s._v("管道（pipe）")]),s._v(" 等。本文主要介绍 "),a("code",[s._v("管道")]),s._v(" 的原理与实现。")]),s._v(" "),a("h2",{attrs:{id:"一、管道的使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、管道的使用"}},[s._v("#")]),s._v(" "),a("strong",[s._v("一、管道的使用")])]),s._v(" "),a("p",[a("code",[s._v("管道")]),s._v(" 一般用于父子进程之间相互通信，一般的用法如下：")]),s._v(" "),a("ul",[a("li",[s._v("父进程使用 "),a("code",[s._v("pipe")]),s._v(" 系统调用创建一个管道。")]),s._v(" "),a("li",[s._v("然后父进程使用 "),a("code",[s._v("fork")]),s._v(" 系统调用创建一个子进程。")]),s._v(" "),a("li",[s._v("由于子进程会继承父进程打开的文件句柄，所以父子进程可以通过新创建的管道进行通信。")])]),s._v(" "),a("p",[s._v("其原理如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010105252444.png",alt:"img"}})]),s._v(" "),a("p",[s._v("由于管道分为读端和写端，所以需要两个文件描述符来管理管道："),a("code",[s._v("fd[0]")]),s._v(" 为读端，"),a("code",[s._v("fd[1]")]),s._v(" 为写端。")]),s._v(" "),a("p",[s._v("下面代码介绍了怎么使用 "),a("code",[s._v("pipe")]),s._v(" 系统调用来创建一个管道：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[s._v("#include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("stdio"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n#include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("unistd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n#include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("sys"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n#include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("stdlib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n#include "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\nint "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    int ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    int fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 用于管理管道的文件描述符")]),s._v("\n    pid_t pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    char buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    char "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建一个管理")]),s._v("\n    ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to create pipe\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  \n    pid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建子进程")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 子进程")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 关闭管道的读端")]),s._v("\n        ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("strlen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 向管道写端写入数据")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 父进程")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 关闭管道的写端")]),s._v("\n        ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从管道的读端读取数据")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"parent read %d bytes data: %s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("p",[s._v("编译代码：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# gcc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("g pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o pipe\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("p",[s._v("运行代码，输出结果如下：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("pipe\nparent read "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" bytes data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" hello world\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("h2",{attrs:{id:"二、管道的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、管道的实现"}},[s._v("#")]),s._v(" "),a("strong",[s._v("二、管道的实现")])]),s._v(" "),a("p",[s._v("每个进程的用户空间都是独立的，但内核空间却是共用的。所以，进程间通信必须由内核提供服务。前面介绍了 "),a("code",[s._v("管道(pipe)")]),s._v(" 的使用，接下来将会介绍管道在内核中的实现方式。")]),s._v(" "),a("blockquote",[a("p",[s._v("本文使用 Linux-2.6.23 内核作为分析对象。")])]),s._v(" "),a("h3",{attrs:{id:"_1-环形缓冲区-ring-buffer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-环形缓冲区-ring-buffer"}},[s._v("#")]),s._v(" "),a("strong",[s._v("1. 环形缓冲区（Ring Buffer）")])]),s._v(" "),a("p",[s._v("在内核中，"),a("code",[s._v("管道")]),s._v(" 使用了环形缓冲区来存储数据。环形缓冲区的原理是：把一个缓冲区当成是首尾相连的环，其中通过读指针和写指针来记录读操作和写操作位置。如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010105303968.png",alt:"img"}})]),s._v(" "),a("p",[s._v("在 Linux 内核中，使用了 16 个内存页作为环形缓冲区，所以这个环形缓冲区的大小为 64KB（16 * 4KB）。")]),s._v(" "),a("p",[s._v("当向管道写数据时，从写指针指向的位置开始写入，并且将写指针向前移动。而从管道读取数据时，从读指针开始读入，并且将读指针向前移动。当对没有数据可读的管道进行读操作，将会阻塞当前进程。而对没有空闲空间的管道进行写操作，也会阻塞当前进程。")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：可以将管道文件描述符设置为非阻塞，这样对管道进行读写操作时，就不会阻塞当前进程。")])]),s._v(" "),a("h3",{attrs:{id:"_2-管道对象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-管道对象"}},[s._v("#")]),s._v(" "),a("strong",[s._v("2. 管道对象")])]),s._v(" "),a("p",[s._v("在 Linux 内核中，管道使用 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象来进行管理。我们先来看看 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象的定义，如下所示：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[s._v("struct pipe_inode_info "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    wait_queue_head_t wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    unsigned int nrbufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    unsigned int curbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    unsigned int readers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    unsigned int writers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    unsigned int waiting_writers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    struct inode "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("inode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    struct pipe_buffer bufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("p",[s._v("下面介绍一下 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象各个字段的作用：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("wait")]),s._v("：等待队列，用于存储正在等待管道可读或者可写的进程。")]),s._v(" "),a("li",[a("code",[s._v("bufs")]),s._v("：环形缓冲区，由 16 个 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象组成，每个 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象拥有一个内存页 ，后面会介绍。")]),s._v(" "),a("li",[a("code",[s._v("nrbufs")]),s._v("：表示未读数据已经占用了环形缓冲区的多少个内存页。")]),s._v(" "),a("li",[a("code",[s._v("curbuf")]),s._v("：表示当前正在读取环形缓冲区的哪个内存页中的数据。")]),s._v(" "),a("li",[a("code",[s._v("readers")]),s._v("：表示正在读取管道的进程数。")]),s._v(" "),a("li",[a("code",[s._v("writers")]),s._v("：表示正在写入管道的进程数。")]),s._v(" "),a("li",[a("code",[s._v("waiting_writers")]),s._v("：表示等待管道可写的进程数。")]),s._v(" "),a("li",[a("code",[s._v("inode")]),s._v("：与管道关联的 "),a("code",[s._v("inode")]),s._v(" 对象。")])]),s._v(" "),a("p",[s._v("由于环形缓冲区是由 16 个 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象组成，所以下面我们来看看 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的定义：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[s._v("struct pipe_buffer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    struct page "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("page"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    unsigned int offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    unsigned int len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("p",[s._v("下面介绍一下 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象各个字段的作用：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("page")]),s._v("：指向 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象占用的内存页。")]),s._v(" "),a("li",[a("code",[s._v("offset")]),s._v("：如果进程正在读取当前内存页的数据，那么 "),a("code",[s._v("offset")]),s._v(" 指向正在读取当前内存页的偏移量。")]),s._v(" "),a("li",[a("code",[s._v("len")]),s._v("：表示当前内存页拥有未读数据的长度。")])]),s._v(" "),a("p",[s._v("下图展示了 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象与 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的关系：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620.jpeg",alt:"img"}})]),s._v(" "),a("p",[s._v("管道的环形缓冲区实现方式与经典的环形缓冲区实现方式有点区别，经典的环形缓冲区一般先申请一块地址连续的内存块，然后通过读指针与写指针来对读操作与写操作进行定位。")]),s._v(" "),a("p",[s._v("但为了减少对内存的使用，内核不会在创建管道时就申请 64K 的内存块，而是在进程向管道写入数据时，按需来申请内存。")]),s._v(" "),a("p",[s._v("那么当进程从管道读取数据时，内核怎么处理呢？下面我们来看看管道读操作的实现方式。")]),s._v(" "),a("h3",{attrs:{id:"_3-读操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-读操作"}},[s._v("#")]),s._v(" "),a("strong",[s._v("3. 读操作")])]),s._v(" "),a("p",[s._v("从 "),a("code",[s._v("经典的环形缓冲区")]),s._v(" 中读取数据时，首先通过读指针来定位到读取数据的起始地址，然后判断环形缓冲区中是否有数据可读，如果有就从环形缓冲区中读取数据到用户空间的缓冲区中。如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010105321742.png",alt:"img"}})]),s._v(" "),a("p",[s._v("而 "),a("code",[s._v("管道的环形缓冲区")]),s._v(" 与 "),a("code",[s._v("经典的环形缓冲区")]),s._v(" 实现稍有不同，"),a("code",[s._v("管道的环形缓冲区")]),s._v(" 其读指针是由 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象的 "),a("code",[s._v("curbuf")]),s._v(" 字段与 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("offset")]),s._v(" 字段组合而成：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("pipe_inode_info")]),s._v(" 对象的 "),a("code",[s._v("curbuf")]),s._v(" 字段表示读操作要从 "),a("code",[s._v("bufs")]),s._v(" 数组的哪个 "),a("code",[s._v("pipe_buffer")]),s._v(" 中读取数据。")]),s._v(" "),a("li",[a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("offset")]),s._v(" 字段表示读操作要从内存页的哪个位置开始读取数据。")])]),s._v(" "),a("p",[s._v("读取数据的过程如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010105328265.png",alt:"img"}})]),s._v(" "),a("p",[s._v("从缓冲区中读取到 n 个字节的数据后，会相应移动读指针 n 个字节的位置（也就是增加 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("offset")]),s._v(" 字段），并且减少 n 个字节的可读数据长度（也就是减少 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("len")]),s._v(" 字段）。")]),s._v(" "),a("p",[s._v("当 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("len")]),s._v(" 字段变为 0 时，表示当前 "),a("code",[s._v("pipe_buffer")]),s._v(" 没有可读数据，那么将会对 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象的 "),a("code",[s._v("curbuf")]),s._v(" 字段移动一个位置，并且其 "),a("code",[s._v("nrbufs")]),s._v(" 字段进行减一操作。")]),s._v(" "),a("p",[s._v("我们来看看管道读操作的代码实现，读操作由 "),a("code",[s._v("pipe_read")]),s._v(" 函数完成。为了突出重点，我们只列出关键代码，如下所示：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" ssize_t\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipe_read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("struct kiocb "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("iocb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" struct iovec "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_iov"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" unsigned long nr_segs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          loff_t pos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    struct pipe_inode_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1. 获取管道对象")]),s._v("\n    pipe "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" inode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("i_pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2. 获取管道未读数据占有多少个内存页")]),s._v("\n        int bufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("nrbufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3. 获取读操作应该从环形缓冲区的哪个内存页处读取数据")]),s._v("\n            int curbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("curbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n            struct pipe_buffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("bufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" curbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* 4. 通过 pipe_buffer 的 offset 字段获取真正的读指针,\n             *    并且从管道中读取数据到用户缓冲区.\n             */")]),s._v("\n            error "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipe_iov_copy_to_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("iov"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" addr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" atomic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n\n            ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 增加 pipe_buffer 对象的 offset 字段的值")]),s._v("\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 减少 pipe_buffer 对象的 len 字段的值")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* 5. 如果当前内存页的数据已经被读取完毕 */")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n                curbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("curbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PIPE_BUFFERS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("curbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" curbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 移动 pipe_inode_info 对象的 curbuf 指针")]),s._v("\n                pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("nrbufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("bufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 减少 pipe_inode_info 对象的 nrbufs 字段")]),s._v("\n                do_wakeup "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n            total_len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 6. 如果读取到用户期望的数据长度, 退出循环")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("total_len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("p",[s._v("上面代码总结来说分为以下步骤：")]),s._v(" "),a("ul",[a("li",[s._v("通过文件 "),a("code",[s._v("inode")]),s._v(" 对象来获取到管道的 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象。")]),s._v(" "),a("li",[s._v("通过 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象的 "),a("code",[s._v("nrbufs")]),s._v(" 字段获取管道未读数据占有多少个内存页。")]),s._v(" "),a("li",[s._v("通过 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象的 "),a("code",[s._v("curbuf")]),s._v(" 字段获取读操作应该从环形缓冲区的哪个内存页处读取数据。")]),s._v(" "),a("li",[s._v("通过 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("offset")]),s._v(" 字段获取真正的读指针， 并且从管道中读取数据到用户缓冲区。")]),s._v(" "),a("li",[s._v("如果当前内存页的数据已经被读取完毕，那么移动 "),a("code",[s._v("pipe_inode_info")]),s._v(" 对象的 "),a("code",[s._v("curbuf")]),s._v(" 指针，并且减少其 "),a("code",[s._v("nrbufs")]),s._v(" 字段的值。")]),s._v(" "),a("li",[s._v("如果读取到用户期望的数据长度，退出循环。")])]),s._v(" "),a("h3",{attrs:{id:"_4-写操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-写操作"}},[s._v("#")]),s._v(" "),a("strong",[s._v("4. 写操作")])]),s._v(" "),a("p",[s._v("分析完管道读操作的实现后，接下来，我们分析一下管道写操作的实现。")]),s._v(" "),a("p",[a("code",[s._v("经典的环形缓冲区")]),s._v(" 写入数据时，首先通过写指针进行定位要写入的内存地址，然后判断环形缓冲区的空间是否足够，足够就把数据写入到环形缓冲区中。如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010105338849.png",alt:"img"}})]),s._v(" "),a("p",[s._v("但 "),a("code",[s._v("管道的环形缓冲区")]),s._v(" 并没有保存 "),a("code",[s._v("写指针")]),s._v("，而是通过 "),a("code",[s._v("读指针")]),s._v(" 计算出来。那么怎么通过读指针计算出写指针呢？")]),s._v(" "),a("p",[s._v("其实很简单，就是：")]),s._v(" "),a("blockquote",[a("p",[s._v("写指针 = 读指针 + 未读数据长度")])]),s._v(" "),a("p",[s._v("下面我们来看看，向管道写入 200 字节数据的过程示意图，如下所示：")]),s._v(" "),a("p",[s._v("如上图所示，向管道写入数据时：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/AdmireAn/blobImage@main/img/1620-20221010105347437.png",alt:"img"}})]),s._v(" "),a("ul",[a("li",[s._v("首先通过 "),a("code",[s._v("pipe_inode_info")]),s._v(" 的 "),a("code",[s._v("curbuf")]),s._v(" 字段和 "),a("code",[s._v("nrbufs")]),s._v(" 字段来定位到，应该向哪个 "),a("code",[s._v("pipe_buffer")]),s._v(" 写入数据。")]),s._v(" "),a("li",[s._v("然后再通过 "),a("code",[s._v("pipe_buffer")]),s._v(" 对象的 "),a("code",[s._v("offset")]),s._v(" 字段和 "),a("code",[s._v("len")]),s._v(" 字段来定位到，应该写入到内存页的哪个位置。")])]),s._v(" "),a("p",[s._v("下面我们通过源码来分析，写操作是怎么实现的，代码如下（为了特出重点，代码有所删减）：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" ssize_t\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipe_write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("struct kiocb "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("iocb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" struct iovec "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_iov"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" unsigned "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" nr_segs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n           loff_t ppos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    struct pipe_inode_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    pipe "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" inode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("i_pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    chars "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" total_len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PAGE_SIZE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* size of the last buffer */")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1. 如果最后写入的 pipe_buffer 还有空闲的空间")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("nrbufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" chars "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取写入数据的位置")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" lastbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("curbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("nrbufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PIPE_BUFFERS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        struct pipe_buffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("bufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" lastbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" struct pipe_buf_operations "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ops "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ops"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("can_merge "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" chars "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" PAGE_SIZE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            error "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipe_iov_copy_from_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" addr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" iov"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" atomic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            total_len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果要写入的数据已经全部写入成功, 退出循环")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("total_len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("goto")]),s._v(" out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2. 如果最后写入的 pipe_buffer 空闲空间不足, 那么申请一个新的内存页来存储数据")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" bufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        bufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("nrbufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" PIPE_BUFFERS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" newbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("curbuf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" bufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PIPE_BUFFERS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            struct pipe_buffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("bufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" newbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 申请一个新的内存页")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("page"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                page "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("alloc_page")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GFP_HIGHUSER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            error "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipe_iov_copy_from_user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" iov"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" atomic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            ret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("page "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" page"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ops "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("anon_pipe_buf_ops"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            buf"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("nrbufs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("bufs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            pipe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tmp_page "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" NULL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果要写入的数据已经全部写入成功, 退出循环")]),s._v("\n            total_len "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-=")]),s._v(" chars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("total_len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br")])]),a("p",[s._v("复制")]),s._v(" "),a("p",[s._v("上面代码有点长，但是逻辑却很简单，主要进行如下操作：")]),s._v(" "),a("ul",[a("li",[s._v("如果上次写操作写入的 "),a("code",[s._v("pipe_buffer")]),s._v(" 还有空闲的空间，那么就将数据写入到此 "),a("code",[s._v("pipe_buffer")]),s._v(" 中，并且增加其 "),a("code",[s._v("len")]),s._v(" 字段的值。")]),s._v(" "),a("li",[s._v("如果上次写操作写入的 "),a("code",[s._v("pipe_buffer")]),s._v(" 没有足够的空闲空间，那么就新申请一个内存页，并且把数据保存到新的内存页中，并且增加 "),a("code",[s._v("pipe_inode_info")]),s._v(" 的 "),a("code",[s._v("nrbufs")]),s._v(" 字段的值。")]),s._v(" "),a("li",[s._v("如果写入的数据已经全部写入成功，那么就退出写操作。")])]),s._v(" "),a("h2",{attrs:{id:"三、思考一下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、思考一下"}},[s._v("#")]),s._v(" "),a("strong",[s._v("三、思考一下")])]),s._v(" "),a("p",[s._v("管道读写操作的实现已经分析完毕，现在我们来思考一下以下问题。")]),s._v(" "),a("h3",{attrs:{id:"_1-为什么父子进程可以通过管道来通信"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么父子进程可以通过管道来通信"}},[s._v("#")]),s._v(" "),a("strong",[s._v("1. 为什么父子进程可以通过管道来通信？")])]),s._v(" "),a("p",[s._v("这是因为父子进程通过 "),a("code",[s._v("pipe")]),s._v(" 系统调用打开的管道，在内核空间中指向同一个管道对象（"),a("code",[s._v("pipe_inode_info")]),s._v("）。所以父子进程共享着同一个管道对象，那么就可以通过这个共享的管道对象进行通信。")]),s._v(" "),a("h3",{attrs:{id:"_2-为什么内核要使用-16-个内存页进行数据存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-为什么内核要使用-16-个内存页进行数据存储"}},[s._v("#")]),s._v(" "),a("strong",[s._v("2. 为什么内核要使用 16 个内存页进行")]),s._v("数据存储？")]),s._v(" "),a("p",[s._v("这是为了减少内存使用。")]),s._v(" "),a("p",[s._v("因为使用 "),a("code",[s._v("pipe")]),s._v(" 系统调用打开管道时，并没有立刻申请内存页，而是当有进程向管道写入数据时，才会按需申请内存页。当内存页的数据被读取完后，内核会将此内存页回收，来减少管道对内存的使用。")]),s._v(" "),a("h2",{attrs:{id:"四-参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-参考"}},[s._v("#")]),s._v(" 四 参考")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1890707",target:"_blank",rel:"noopener noreferrer"}},[s._v("图解 | Linux进程通信 - 管道实现"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);